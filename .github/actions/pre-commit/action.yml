# Copyright 2024 Wolfgang Hoschek AT mac DOT com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Run pre-commit
description: Run pre-commit with manual hooks enabled (CI settings)

inputs:
  python-version:
    description: Python version used by this job
    required: true
  precommit-python-versions:
    description: JSON array of Python versions allowed to run pre-commit (empty means always run)
    required: false
    default: '["3.10", "3.11", "3.12", "3.13", "3.14", "3.15", "3.16", "3.17", "3.18", "3.19"]'

runs:
  using: 'composite'
  steps:
  - name: Run pre-commit
    if: ${{ inputs.precommit-python-versions == '' || contains(fromJson(inputs.precommit-python-versions), inputs.python-version) }}
    shell: bash
    run: |
      python -m pip install --upgrade pip
      pip install -e '.[dev]'
      # In CI, disable pre-commit fail_fast so all hooks run and report.
      # This keeps local developer experience unchanged (fail_fast remains true in the repo config).
      sed -i 's/^fail_fast:\s*true/fail_fast: false/' .pre-commit-config.yaml
      echo "[CI] pre-commit fail_fast is now set to: $(grep '^fail_fast:' .pre-commit-config.yaml)"
      # Run all normal pre-commit hooks, plus the manual stage for CI-only checks such as cyclic import detection by pylint
      pre-commit run --all-files --hook-stage manual
