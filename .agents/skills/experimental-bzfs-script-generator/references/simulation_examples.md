# Simulation Examples (Option 2)

This file captures three representative script pairs drafted as if generated by the skill. Use it as a quality bar for
future outputs.

## Scenario 1: Read-only snapshot comparison (ad hoc)

```bash
#!/usr/bin/env bash
set -euo pipefail

SRC_DATASET="tank/app"
DST_DATASET="tank_bak/app"

# Optional read-only preflight checks:
zfs list -H -o name "$SRC_DATASET" >/dev/null
zfs list -H -o name "$DST_DATASET" >/dev/null

cmd=(
  bzfs "$SRC_DATASET" "$DST_DATASET"
  --recursive
  --skip-replication
  --compare-snapshot-lists=src+dst+all
  --include-snapshot-regex '.*_(hourly|daily)'
)

printf 'Review command before run:\n'
printf '  %q' "${cmd[@]}"
printf '\n'
"${cmd[@]}"
```

```python
#!/usr/bin/env python3
"""Compare source and destination snapshots in read-only mode."""

from __future__ import annotations

import shlex
import subprocess


def main() -> None:
    src_dataset = "tank/app"
    dst_dataset = "tank_bak/app"

    subprocess.run(["zfs", "list", "-H", "-o", "name", src_dataset], check=True)
    subprocess.run(["zfs", "list", "-H", "-o", "name", dst_dataset], check=True)

    cmd = [
        "bzfs",
        src_dataset,
        dst_dataset,
        "--recursive",
        "--skip-replication",
        "--compare-snapshot-lists=src+dst+all",
        "--include-snapshot-regex",
        ".*_(hourly|daily)",
    ]

    print("Review command before run:")
    print("  " + shlex.join(cmd))
    subprocess.run(cmd, check=True)


if __name__ == "__main__":
    main()
```

## Scenario 2: Safe destination pruning (state-changing, dry-run default)

```bash
#!/usr/bin/env bash
set -euo pipefail

SRC_DATASET="tank/app"
DST_DATASET="tank_bak/app"
DRYRUN="${DRYRUN:-1}"  # keep 1 for safety

cmd=(
  bzfs "$SRC_DATASET" "$DST_DATASET"
  --recursive
  --skip-replication
  --delete-dst-snapshots
  --include-snapshot-regex '.*_daily'
  --include-snapshot-times-and-ranks "notime" "all except latest 7"
  --include-snapshot-times-and-ranks "anytime..7 days ago"
)

if [[ "$DRYRUN" == "1" ]]; then
  cmd+=(--dryrun)
fi

printf 'Review command before run:\n'
printf '  %q' "${cmd[@]}"
printf '\n'
"${cmd[@]}"
```

```python
#!/usr/bin/env python3
"""Prune destination snapshots with dry-run enabled by default."""

from __future__ import annotations

import os
import shlex
import subprocess


def main() -> None:
    src_dataset = "tank/app"
    dst_dataset = "tank_bak/app"
    dryrun = os.getenv("DRYRUN", "1") == "1"

    cmd = [
        "bzfs",
        src_dataset,
        dst_dataset,
        "--recursive",
        "--skip-replication",
        "--delete-dst-snapshots",
        "--include-snapshot-regex",
        ".*_daily",
        "--include-snapshot-times-and-ranks",
        "notime",
        "all except latest 7",
        "--include-snapshot-times-and-ranks",
        "anytime..7 days ago",
    ]

    if dryrun:
        cmd.append("--dryrun")

    print("Review command before run:")
    print("  " + shlex.join(cmd))
    subprocess.run(cmd, check=True)


if __name__ == "__main__":
    main()
```

## Scenario 3: Periodic jobrunner replication (state-changing, dry-run default)

This scenario follows `bzfs_testbed/bzfs_job_testbed.py` conventions: destination actions use `--dst-host` (source actions
would use `--src-host`).

```bash
#!/usr/bin/env bash
set -euo pipefail

JOBCONFIG="/bzfs/bzfs_testbed/bzfs_job_testbed.py"
THIS_HOST="$(hostname)"
DRYRUN="${DRYRUN:-1}"  # keep 1 for safety

cmd=("$JOBCONFIG" --dst-host="$THIS_HOST" --replicate --prune-dst-snapshots)

if [[ "$DRYRUN" == "1" ]]; then
  cmd+=(--jobrunner-dryrun --dryrun)
fi

printf 'Review command before run:\n'
printf '  %q' "${cmd[@]}"
printf '\n'
"${cmd[@]}"
```

```python
#!/usr/bin/env python3
"""Run periodic destination replication/pruning with safe defaults."""

from __future__ import annotations

import os
import shlex
import socket
import subprocess


def main() -> None:
    jobconfig = "/bzfs/bzfs_testbed/bzfs_job_testbed.py"
    this_host = socket.gethostname()
    dryrun = os.getenv("DRYRUN", "1") == "1"

    cmd = [jobconfig, f"--dst-host={this_host}", "--replicate", "--prune-dst-snapshots"]

    if dryrun:
        cmd += ["--jobrunner-dryrun", "--dryrun"]

    print("Review command before run:")
    print("  " + shlex.join(cmd))
    subprocess.run(cmd, check=True)


if __name__ == "__main__":
    main()
```

## Findings from Simulation

1. `DRYRUN`/`dryrun` naming is clearer than negative flags (`NO_DRYRUN`).
2. Output should include Bash and Python variants unless the user requests one language.
3. Read-only tasks do not require `--dryrun`; state-changing tasks do.
4. Optional read-only preflight `zfs list` checks reduce operator mistakes.
5. Python command previews should use `shlex.join(cmd)` for correct quoting.
6. For `bzfs_jobrunner` dict/list args, mirror `bzfs_job_testbed.py` and pass `--flag={value}`.
